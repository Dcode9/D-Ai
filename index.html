<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D'Ai</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Dcode9/D-verse/334e4e91469fe01722191b729d92b0c090b77eaf/D_Ai_Logo.ico">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { brand: '#FF4F00', dark: { bg: '#050505', surface: '#0F0F0F', border: '#1F1F1F' } },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #F0F0F0; font-family: 'Inter', sans-serif; overflow: hidden; }
        *::-webkit-scrollbar{width:6px;height:6px}*::-webkit-scrollbar-track{background:transparent}*::-webkit-scrollbar-thumb{background:#333;border-radius:3px}*::-webkit-scrollbar-thumb:hover{background:#555}

        /* --- SPLIT LAYOUT ENGINE --- */
        #app-container { display: flex; width: 100vw; height: 100vh; padding-top: 60px; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* CHAT SECTION (Left) */
        #chat-section { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            min-width: 0; 
            border-right: 1px solid transparent; 
            transition: all 0.4s ease; 
            position: relative;
        }
        
        /* CANVAS SECTION (Right) */
        #canvas-section { 
            width: 0; 
            opacity: 0; 
            display: flex; 
            flex-direction: column; 
            background: #080808; 
            overflow: hidden; 
            transition: all 0.4s ease; 
            transform: translateX(20px); 
        }

        /* SPLIT STATE ACTIVE */
        body.split-view #chat-section { flex: 0 0 30%; border-right-color: #1F1F1F; }
        body.split-view #canvas-section { width: 70%; opacity: 1; transform: translateX(0); }
        
        /* Centering Logic for Chat */
        .chat-container-inner { max-width: 48rem; margin: 0 auto; width: 100%; transition: max-width 0.4s; }
        body.split-view .chat-container-inner { max-width: 100%; padding: 0 1rem; }
        
        /* Markdown & UI */
        .markdown-body { font-size: 0.95rem; line-height: 1.6; color: #d1d5db; }
        .markdown-body p { margin-bottom: 0.8rem; }
        .markdown-body pre { background: #111; padding: 10px; border-radius: 6px; border: 1px solid #222; overflow-x: auto; font-size: 0.85em; }
        .markdown-body code { font-family: 'JetBrains Mono'; background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.85em; }

        /* Artifact Card */
        .artifact-card { background: #111; border: 1px solid #333; border-radius: 8px; overflow: hidden; margin: 0.5rem 0; cursor: pointer; transition: all 0.2s; }
        .artifact-card:hover { border-color: #FF4F00; }
        .artifact-header { background: #161616; padding: 8px 12px; font-size: 10px; font-weight: 700; color: #666; display: flex; justify-content: space-between; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #222; }
        .artifact-body { padding: 10px 12px; display: flex; align-items: center; gap: 10px; }
        .icon-box { width: 32px; height: 32px; background: #222; color: #FF4F00; display: flex; align-items: center; justify-content: center; border-radius: 6px; }

        /* Files Drawer */
        #files-drawer { position: absolute; top: 60px; right: 80px; width: 240px; background: #111; border: 1px solid #333; border-radius: 8px; z-index: 50; opacity: 0; pointer-events: none; transform: translateY(-5px); transition: 0.2s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #files-drawer.open { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .file-entry { padding: 8px 12px; border-bottom: 1px solid #222; font-size: 13px; color: #aaa; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .file-entry:hover { background: #1A1A1A; color: white; }
        
        /* Editor Tabs */
        .tab-btn { padding: 0 16px; height: 100%; display: flex; align-items: center; font-size: 12px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: #FF4F00; border-bottom-color: #FF4F00; }
        
        /* Image Gen */
        .dai-img-container { position: relative; border-radius: 8px; overflow: hidden; margin: 10px 0; border: 1px solid #333; }
    </style>
</head>
<body class="bg-dark-bg">

    <!-- Header -->
    <header class="fixed top-0 left-0 w-full z-50 bg-dark-bg/95 backdrop-blur-md border-b border-dark-border h-[60px] flex items-center justify-between px-6 transition-all duration-500">
        <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/Dcode9/D-verse/334e4e91469fe01722191b729d92b0c090b77eaf/D_Ai_Logo.ico" class="h-8 w-auto">
            <div><h1 class="font-bold leading-none text-white text-lg">D'Ai</h1><p class="text-[9px] text-gray-500 uppercase tracking-widest">Canvas</p></div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="App.toggleFiles()" class="text-gray-400 hover:text-white transition-colors relative" title="Files">
                <i class="fa-regular fa-folder-open text-lg"></i>
                <span id="file-count" class="absolute -top-2 -right-2 bg-brand text-white text-[9px] px-1 rounded-full hidden">0</span>
            </button>
            <button onclick="location.reload()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-rotate-right text-lg"></i></button>
        </div>

        <!-- Files List -->
        <div id="files-drawer">
            <div class="p-2 border-b border-[#222] text-[10px] font-bold text-gray-500 uppercase">Created Files</div>
            <div id="file-list-container" class="max-h-60 overflow-y-auto">
                <div class="p-3 text-center text-xs text-gray-600 italic">No files yet</div>
            </div>
        </div>
    </header>

    <!-- Main App -->
    <div id="app-container">
        
        <!-- Left: Chat -->
        <div id="chat-section">
            <div id="chat-scroll" class="flex-1 overflow-y-auto p-4 pb-32 scroll-smooth">
                <div class="chat-container-inner h-full flex flex-col">
                    <div id="hero" class="flex-1 flex flex-col items-center justify-center opacity-70 select-none">
                        <img src="https://raw.githubusercontent.com/Dcode9/D-verse/334e4e91469fe01722191b729d92b0c090b77eaf/D_Ai_Logo.ico" class="h-16 w-auto mb-4 grayscale">
                        <p class="text-sm text-gray-500 font-mono">Ready to code.</p>
                    </div>
                    <!-- Messages Injected Here -->
                </div>
            </div>
            
            <!-- Input -->
            <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-dark-bg via-dark-bg to-transparent z-20">
                <div class="chat-container-inner">
                    <div class="bg-dark-surface rounded-full border border-dark-border flex items-end p-2 px-4 shadow-2xl relative transition-all duration-300">
                        <textarea id="in" rows="1" class="w-full bg-transparent text-white p-3.5 max-h-40 resize-none outline-none placeholder-gray-600 text-[14px]" placeholder="Ask D'Ai..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();App.send()}"></textarea>
                        <button onclick="App.send()" id="send-btn" class="p-3 text-gray-500 hover:text-brand transition-colors"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Canvas (70/30 Split) -->
        <div id="canvas-section">
            <!-- Canvas Header -->
            <div class="h-10 border-b border-dark-border flex items-center justify-between px-4 bg-[#0F0F0F]">
                <div class="flex h-full gap-2">
                    <button class="tab-btn active" onclick="App.switchTab('preview')"><i class="fa-solid fa-play mr-2 text-[10px]"></i>Preview</button>
                    <button class="tab-btn" onclick="App.switchTab('code')"><i class="fa-solid fa-code mr-2 text-[10px]"></i>Code</button>
                </div>
                <div class="flex items-center gap-3">
                    <span id="active-filename" class="text-xs font-mono text-gray-500 border border-[#222] px-2 py-0.5 rounded">index.html</span>
                    <button onclick="App.closeCanvas()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <!-- Canvas Body -->
            <div class="flex-1 relative">
                <div id="view-preview" class="absolute inset-0 w-full h-full bg-white z-10">
                    <iframe id="preview-frame" class="w-full h-full border-none"></iframe>
                </div>
                <div id="view-code" class="absolute inset-0 w-full h-full bg-[#080808] z-0 hidden">
                    <textarea id="code-editor" class="w-full h-full bg-[#0B0B0B] text-[#e0e0e0] font-mono text-xs p-4 resize-none outline-none border-none" spellcheck="false" oninput="App.updateCode(this.value)"></textarea>
                </div>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath@1.0.0/texmath.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>

    <script>
        const VERCEL_TAVILY_ENV = (typeof process !== 'undefined' && process.env && process.env.WEB_SEARCH_API) || ""; 

        const App = {
            files: {}, 
            activeFile: null,
            msgHistory: [],
            isGen: false,
            md: null,

            init: () => {
                const checkDeps = () => window.markdownit && window.texmath && window.katex && window.hljs;
                const i = setInterval(() => {
                    if (checkDeps()) {
                        clearInterval(i);
                        App.md = window.markdownit({html:true,breaks:true,linkify:true,highlight:(s,l)=>l&&hljs.getLanguage(l)?hljs.highlight(s,{language:l}).value:''})
                                .use(texmath,{engine:katex,delimiters:'dollars'});
                    }
                }, 100);
            },

            // --- LAYOUT & CANVAS ---
            toggleFiles: () => document.getElementById('files-drawer').classList.toggle('open'),
            
            closeCanvas: () => {
                document.body.classList.remove('split-view');
            },

            openCanvas: (name) => {
                if(!App.files[name]) return;
                App.activeFile = name;
                document.getElementById('active-filename').innerText = name;
                document.getElementById('code-editor').value = App.files[name];
                App.renderPreview(App.files[name]);
                document.body.classList.add('split-view');
                document.getElementById('files-drawer').classList.remove('open');
                App.updateFileList();
            },

            switchTab: (t) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                const p = document.getElementById('view-preview');
                const c = document.getElementById('view-code');
                if(t==='preview') { p.classList.remove('hidden'); c.classList.add('hidden'); App.renderPreview(App.files[App.activeFile]); }
                else { p.classList.add('hidden'); c.classList.remove('hidden'); document.getElementById('code-editor').value = App.files[App.activeFile]; }
            },

            updateCode: (val) => { if(App.activeFile) App.files[App.activeFile] = val; },

            renderPreview: (code) => {
                const doc = document.getElementById('preview-frame').contentWindow.document;
                doc.open(); doc.write(code); doc.close();
            },

            addFile: (name, content) => {
                App.files[name] = content;
                App.updateFileList();
            },

            updateFileList: () => {
                const c = document.getElementById('file-list-container');
                const keys = Object.keys(App.files);
                document.getElementById('file-count').innerText = keys.length;
                document.getElementById('file-count').classList.toggle('hidden', keys.length===0);
                
                if(keys.length===0) { c.innerHTML = '<div class="p-3 text-center text-xs text-gray-600 italic">No files yet</div>'; return; }
                
                c.innerHTML = keys.map(k => `
                    <div class="file-entry" onclick="App.openCanvas('${k}')">
                        <i class="fa-brands fa-html5 text-brand"></i>
                        <span class="flex-1 ${k===App.activeFile?'text-white font-bold':'text-gray-400'}">${k}</span>
                    </div>
                `).join('');
            },

            // --- AI LOGIC ---
            searchTavily: async (q) => {
                let k = VERCEL_TAVILY_ENV || localStorage.getItem('tavily_key');
                if(!k) { k=prompt("Tavily API Key:"); if(k) localStorage.setItem('tavily_key',k); else return null; }
                try {
                    const r = await fetch('https://api.tavily.com/search', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({api_key:k, query:q, search_depth:"basic", max_results:5})
                    });
                    const d = await r.json();
                    return d.results?.map(x=>`Src: ${x.title}\n${x.content}`).join('\n\n') || null;
                } catch(e) { return null; }
            },

            genImage: (p) => {
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?width=1024&height=1024&nologo=true&seed=${Math.random()}`;
                return `<div class="dai-img-container"><img src="${url}" class="w-full"></div>`;
            },

            send: async () => {
                const el = document.getElementById('in');
                const t = el.value.trim();
                if(!t || App.isGen || !App.md) return;
                
                App.isGen = true;
                el.value = '';
                document.getElementById('hero').classList.add('hidden');

                const container = document.querySelector('.chat-container-inner'); // Target the centered container
                
                // User Bubble
                container.innerHTML += `<div class="flex justify-end mb-6"><div class="bg-[#1A1A1A] border border-[#333] px-5 py-3 rounded-2xl rounded-tr-sm text-sm text-white max-w-[90%]">${t.replace(/</g,'&lt;')}</div></div>`;
                
                // Bot Placeholder
                const botId = `bot-${Date.now()}`;
                container.innerHTML += `<div class="flex justify-start mb-6 w-full"><div id="${botId}" class="markdown-body w-full pl-2"><i class="fa-solid fa-circle-notch fa-spin text-brand"></i></div></div>`;
                const botEl = document.getElementById(botId);
                
                // System Prompt - ADDITIVE
                if(App.msgHistory.length === 0) {
                    App.msgHistory.push({
                        role: "system",
                        content: `You are D'Ai, a fast AI assistant. 
                        CAPABILITIES:
                        1. Web Search: If asked about current events/news, use the search tool.
                        2. Image Gen: If asked to draw/generate, use format: <<GENERATE_IMAGE: prompt>>
                        3. VIBE CODING (HTML/Apps): 
                           - You MUST use this EXACT protocol for files: |||"filename.html"||...HTML CODE...|||
                           - The HTML code must be inside the second set of pipes.
                           - Do NOT use markdown code blocks (\`\`\`) for the HTML file content.
                           - You can write normal text outside the pipes.`
                    });
                }
                App.msgHistory.push({role:"user", content:t});

                // Search Hook
                if(/latest|news|today|price|who is/i.test(t)) {
                    botEl.innerHTML = `<span class="text-brand text-xs font-mono animate-pulse">SEARCHING WEB...</span>`;
                    const s = await App.searchTavily(t);
                    if(s) App.msgHistory[App.msgHistory.length-1].content += `\n\n[SEARCH CONTEXT]:\n${s}`;
                }

                try {
                    const res = await fetch("/api/chat", {
                        method: "POST", headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({ model: "gpt-oss-120b", messages: App.msgHistory, stream: true })
                    });
                    
                    const reader = res.body.getReader();
                    const dec = new TextDecoder();
                    let full = "";

                    while(true) {
                        const {done, value} = await reader.read();
                        if(done) break;
                        
                        const chunk = dec.decode(value, {stream:true});
                        const lines = chunk.split('\n');
                        for(const line of lines) {
                            if(line.startsWith('data: ') && line !== 'data: [DONE]') {
                                const delta = JSON.parse(line.slice(6)).choices[0]?.delta?.content || "";
                                full += delta;
                                
                                // Protocol Parsing & Stripping
                                // Regex: |||"name"||content|||
                                // We replace the entire block with a card for the display
                                let display = full;
                                const regex = /\|\|\|"([^"]+)"\|\|([\s\S]*?)(\|\|\||$)/g;
                                let match;
                                while((match = regex.exec(full)) !== null) {
                                    const [block, fname, code, closer] = match;
                                    
                                    // Store File
                                    if(code.length > 10) {
                                        if(!App.files[fname] || App.files[fname]!==code) {
                                            App.addFile(fname, code);
                                            // Auto-open if specific closer found
                                            if(closer==='|||') App.openCanvas(fname); 
                                        }
                                    }

                                    // Replace in Chat UI
                                    const card = `<div class="artifact-card" onclick="App.openCanvas('${fname}')">
                                        <div class="artifact-header"><span>Artifact Created</span><i class="fa-solid fa-arrow-up-right-from-square text-brand"></i></div>
                                        <div class="artifact-body">
                                            <div class="icon-box"><i class="fa-brands fa-html5"></i></div>
                                            <div><div class="text-white font-bold text-sm">${fname}</div><div class="text-[10px] text-gray-500">Click to view Code & Preview</div></div>
                                        </div>
                                    </div>`;
                                    display = display.replace(block, card);
                                }

                                // Image
                                display = display.replace(/<<GENERATE_IMAGE:([^>]+)>>/g, (m,p) => App.genImage(p));

                                botEl.innerHTML = App.md.render(display);
                                document.getElementById('chat-scroll').scrollTop = document.getElementById('chat-scroll').scrollHeight;
                            }
                        }
                    }
                    App.msgHistory.push({role:"assistant", content:full});
                    App.isGen = false;
                } catch(e) {
                    botEl.innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
                    App.isGen = false;
                }
            }
        };

        App.init();
    </script>
</body>
</html>
